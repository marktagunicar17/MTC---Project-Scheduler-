<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>MTagunicar Construction - Project Manager</title>

    <!-- React + Babel -->
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/@babel/standalone@7.26.2/babel.min.js"></script>

    <!-- Recharts (UMD) -->
    <script crossorigin src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>

    <!-- TRY loading gantt-task-react (may not expose UMD global in all versions) -->
    <!-- If this fails, we fall back to a simple Gantt renderer below -->
    <link rel="stylesheet" href="https://unpkg.com/gantt-task-react@0.3.9/dist/index.css" />
    <script crossorigin src="https://unpkg.com/gantt-task-react@0.3.9/dist/index.js"></script>

    <style>
      body {
        margin: 0;
        font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        background: linear-gradient(to bottom, #ffffff 0%, #e0f2fe 100%);
        color: #0b2e59;
        min-height: 100vh;
      }
      .container { max-width: 1400px; margin: 0 auto; padding: 1rem; }
      h1,h2 { margin: .5rem 0; }
      table { width: 100%; border-collapse: collapse; }
      th, td { border: 1px solid #e5eefb; padding: .5rem; vertical-align: middle; }
      th { background: #f1f7ff; }
      input, select, textarea { width: 100%; box-sizing: border-box; }
      .panel { background: #fff; border: 1px solid #e5eefb; border-radius: 12px; padding: 16px; }
      .row { display: grid; gap: 16px; }
      @media (min-width: 900px){ .row.cols-2 { grid-template-columns: 1fr 1fr; } }
      /* Simple Gantt styles */
      .gantt-wrap { overflow-x: auto; background: #fff; border: 1px solid #e5eefb; border-radius: 12px; }
      .gantt { position: relative; min-width: 900px; padding: 12px 12px 24px; }
      .gantt-grid { display: grid; grid-template-columns: 220px 1fr; gap: 0; }
      .gantt-row { display: contents; }
      .gantt-label { padding: 6px 8px; border-bottom: 1px solid #eef4ff; background: #fff; }
      .gantt-track { position: relative; height: 36px; border-bottom: 1px solid #eef4ff; background:
        repeating-linear-gradient(to right, #ffffff 0 64px, #f9fbff 64px 65px); }
      .gantt-bar { position: absolute; top: 6px; height: 24px; border-radius: 6px;
        background: #1e90ff; color: #fff; display: flex; align-items: center; justify-content: center;
        font-size: 12px; white-space: nowrap; padding: 0 8px; }
      .hint { font-size: 12px; color: #4b6b8f; }
    </style>
  </head>
  <body>
    <div id="root"></div>

    <script type="text/babel">
      const { useState, useMemo, useEffect } = React;
      const Recharts = window.Recharts || {};
      // Try to read the Gantt constructor from different possible UMD exports
      const GanttLib = (window.Gantt && window.Gantt.Gantt)
                    || (window["gantt-task-react"] && window["gantt-task-react"].Gantt)
                    || null;

      // ----- helpers -----
      const toDate = (v, fb=null) => {
        const d = v instanceof Date ? v : new Date(v);
        return isNaN(d) ? (fb ?? null) : d;
      };
      const ymd = (d) => (d ? new Date(d).toISOString().slice(0,10) : "");

      const normalizeTask = (raw, i=0) => {
        const start = toDate(raw.start, new Date());
        let end = toDate(raw.end, new Date(start.getTime()+24*3600*1000));
        if (end < start) end = new Date(start.getTime()+24*3600*1000);
        return {
          id: raw.id || `T-${String(i+1).padStart(3,"0")}`,
          name: raw.name || "New Task",
          owner: raw.owner || "Unassigned",
          status: raw.status || "Planned",
          priority: raw.priority || "Medium",
          progress: Number(raw.progress) || 0,
          start, end
        };
      };

      // ----- sample/project state -----
      const seedTasks = [
        { id:"T-001", name:"BOARD UPS - DRY WALLS", start:"2025-08-18", end:"2025-08-23", owner:"Site", status:"Planned", priority:"High", progress:0 },
        { id:"T-002", name:"ELECTRICAL WORKS",       start:"2025-08-24", end:"2025-09-10", owner:"Elec", status:"In Progress", priority:"Medium", progress:10 }
      ];

      function SimpleGantt({ tasks }) {
        if (!tasks.length) return <div className="hint">No tasks to display.</div>;
        const list = tasks.map(normalizeTask);
        // compute time window
        const min = new Date(Math.min(...list.map(t=>+t.start)));
        const max = new Date(Math.max(...list.map(t=>+t.end)));
        const dayMs = 24*3600*1000;
        const totalDays = Math.max(1, Math.round((max - min)/dayMs) + 1);
        const pxPerDay = 20; // width scale

        return (
          <div className="gantt-wrap">
            <div className="gantt">
              <div className="gantt-grid">
                {list.map(t => {
                  const left = Math.round((t.start - min)/dayMs) * pxPerDay;
                  const width = Math.max(pxPerDay, (Math.round((t.end - t.start)/dayMs)+1)*pxPerDay);
                  return (
                    <React.Fragment key={t.id}>
                      <div className="gantt-label">{t.name}</div>
                      <div className="gantt-track">
                        <div className="gantt-bar" style={{ left, width }}>{t.progress}%</div>
                      </div>
                    </React.Fragment>
                  );
                })}
              </div>
              <div className="hint" style={{marginTop:8}}>
                Simple Gantt shown. To use the advanced React Gantt, deploy with a bundler (Vite) or if the CDN exposes a UMD, it will auto-switch.
              </div>
            </div>
          </div>
        );
      }

      function App() {
        const [info, setInfo] = useState({ name:"Project Name", location:"Project Location", type:"Project Type", headerImage:"" });
        const [tasks, setTasks] = useState(seedTasks.map((t,i)=>normalizeTask(t,i)));
        const [viewMode] = useState("Day");

        const statusData = useMemo(()=>{
          const m = {};
          tasks.forEach(t => { m[t.status] = (m[t.status]||0)+1; });
          const arr = Object.entries(m).map(([name,value])=>({name,value}));
          return arr.length?arr:[{name:"No Data", value:1}];
        },[tasks]);

        const workloadData = useMemo(()=>{
          const m = {};
          tasks.forEach(t => { m[t.owner||"Unassigned"] = (m[t.owner||"Unassigned"]||0)+1; });
          const arr = Object.entries(m).map(([owner,count])=>({owner,count}));
          return arr.length?arr:[{owner:"No Tasks", count:0}];
        },[tasks]);

        const addTask = () => {
          const i = tasks.length + 1;
          setTasks(t=>[...t, normalizeTask({ id:`T-${String(i).padStart(3,"0")}`, name:`New Task ${i}`, start:new Date(), end:new Date(Date.now()+3*24*3600*1000) }, i)]);
        };

        const updateTask = (id, patch) => {
          setTasks(ts => ts.map(t => t.id===id ? normalizeTask({...t, ...patch}) : t));
        };

        // Header
        const Header = (
          <div className="container" style={{position:"relative", paddingTop:0}}>
            <div style={{position:"relative", height:220, overflow:"hidden", borderRadius:12, background:"#fff", border:"1px solid #e5eefb"}}>
              {info.headerImage && <img alt="Header" src={info.headerImage} style={{position:"absolute", inset:0, width:"100%", height:"100%", objectFit:"cover"}}/>}
              <div style={{position:"absolute", inset:0, background:"linear-gradient(180deg, rgba(255,255,255,.6), rgba(255,255,255,.2))"}}/>
              <div style={{position:"absolute", left:16, bottom:12}}>
                <h1 style={{margin:0}}>{info.name}</h1>
                <div style={{opacity:.8}}>{info.location} â€” {info.type}</div>
              </div>
            </div>
          </div>
        );

        // Gantt region: advanced if available, simple otherwise
        const GanttRegion = () => {
          if (GanttLib && Recharts) {
            // build tasks for gantt-task-react
            const gTasks = tasks.map(t => ({
              id: t.id, name: t.name, start: t.start, end: t.end, type: "task", progress: t.progress
            }));
            const Gantt = GanttLib;
            return (
              <div className="panel">
                <h2>Gantt</h2>
                <div style={{border:"1px solid #e5eefb", borderRadius:12, overflow:"auto", background:"#fff"}}>
                  <Gantt
                    tasks={gTasks}
                    viewMode={viewMode}
                    listCellWidth={200}
                    columnWidth={70}
                    onDateChange={(g)=>updateTask(g.id,{start:g.start,end:g.end})}
                    onProgressChange={(g)=>updateTask(g.id,{progress:Math.round(g.progress)})}
                  />
                </div>
              </div>
            );
          }
          // fallback
          return (
            <div className="panel">
              <h2>Gantt</h2>
              <SimpleGantt tasks={tasks}/>
            </div>
          );
        };

        return (
          <>
            {Header}

            <div className="container">
              {/* controls */}
              <div className="panel" style={{marginBottom:16}}>
                <div className="row" style={{gridTemplateColumns:"repeat(5, minmax(0,1fr))", gap:8}}>
                  <input placeholder="Project Name" value={info.name} onChange={e=>setInfo({...info, name:e.target.value})}/>
                  <input placeholder="Location" value={info.location} onChange={e=>setInfo({...info, location:e.target.value})}/>
                  <input placeholder="Type" value={info.type} onChange={e=>setInfo({...info, type:e.target.value})}/>
                  <label style="display:flex;align-items:center;gap:.5rem;border:1px solid #e5eefb;border-radius:8px;padding:.5rem;background:#fff;cursor:pointer">
                    Upload header
                    <input type="file" accept="image/*" style="display:none" onChange={e=>{
                      const f = e.target.files?.[0]; if(!f) return;
                      const r = new FileReader(); r.onload = ev => setInfo({...info, headerImage: ev.target.result}); r.readAsDataURL(f);
                    }}/>
                  </label>
                  <button style="background:#0b5ed7;color:#fff;border:none;border-radius:8px" onClick={addTask}>+ Add Task</button>
                </div>
              </div>

              {/* Board */}
              <div className="panel" style={{marginBottom:16}}>
                <h2>Board</h2>
                <div style="overflow-x:auto">
                  <table>
                    <thead>
                      <tr>
                        <th>Task Name</th><th>Owner</th><th>Status</th><th>Priority</th>
                        <th>Start</th><th>End</th><th>Progress %</th>
                      </tr>
                    </thead>
                    <tbody>
                      {tasks.map(t => (
                        <tr key={t.id}>
                          <td><input value={t.name} onChange={e=>updateTask(t.id,{name:e.target.value})}/></td>
                          <td><input value={t.owner} onChange={e=>updateTask(t.id,{owner:e.target.value})}/></td>
                          <td>
                            <select value={t.status} onChange={e=>updateTask(t.id,{status:e.target.value})}>
                              {["Planned","In Progress","Blocked","Done"].map(s=> <option key={s} value={s}>{s}</option>)}
                            </select>
                          </td>
                          <td>
                            <select value={t.priority} onChange={e=>updateTask(t.id,{priority:e.target.value})}>
                              {["Low","Medium","High","Urgent"].map(p=> <option key={p} value={p}>{p}</option>)}
                            </select>
                          </td>
                          <td><input type="date" value={ymd(t.start)} onChange={e=>updateTask(t.id,{start:new Date(e.target.value)})}/></td>
                          <td><input type="date" value={ymd(t.end)} onChange={e=>updateTask(t.id,{end:new Date(e.target.value)})}/></td>
                          <td><input type="number" min="0" max="100" value={t.progress} onChange={e=>updateTask(t.id,{progress:Math.max(0,Math.min(100,Number(e.target.value||0)))})}/></td>
                        </tr>
                      ))}
                    </tbody>
                  </table>
                </div>
              </div>

              {/* Gantt */}
              <GanttRegion/>

              {/* Dashboards */}
              <div className="row cols-2" style={{marginTop:16}}>
                <div className="panel">
                  <h3>Status Breakdown</h3>
                  {"PieChart" in Recharts
                    ? (
                      <Recharts.PieChart width={320} height={220}>
                        <Recharts.Pie dataKey="value" data={statusData} cx="50%" cy="50%" outerRadius={90} label>
                          {statusData.map((_,i)=> <Recharts.Cell key={i} fill={i%2===0 ? "#1e90ff" : "#60a5fa"} />)}
                        </Recharts.Pie>
                        <Recharts.Legend />
                        <Recharts.Tooltip />
                      </Recharts.PieChart>
                    )
                    : <div className="hint">Recharts not loaded.</div>
                  }
                </div>

                <div className="panel">
                  <h3>Workload by Owner</h3>
                  {"BarChart" in Recharts
                    ? (
                      <Recharts.BarChart width={420} height={220} data={workloadData}>
                        <Recharts.XAxis dataKey="owner" />
                        <Recharts.YAxis allowDecimals={false} />
                        <Recharts.Tooltip />
                        <Recharts.Legend />
                        <Recharts.Bar dataKey="count" fill="#1e90ff" />
                      </Recharts.BarChart>
                    )
                    : <div className="hint">Recharts not loaded.</div>
                  }
                </div>
              </div>
            </div>
          </>
        );
      }

      // Mount React app (do this last so CSS shows even if JS blocked)
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(<App />);
    </script>
  </body>
</html>
